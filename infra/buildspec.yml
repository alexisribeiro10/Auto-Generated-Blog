version: 0.2

env:
  variables:
    AWS_DEFAULT_REGION: eu-west-3
    ECR_REPOSITORY_BACKEND: auto-generated-blog-backend
    ECR_REPOSITORY_FRONTEND: auto-generated-blog-frontend
    EC2_HOST: 13.38.129.46
    EC2_USER: ubuntu
    SSH_KEY_PATH: C:\Users\alexi\asymetric-key.pem

phases:
  install:
    runtime-versions:
      docker: 20
    commands:
      - echo "Instalando dependÃªncias..."
      - sudo apt-get update -y
      - sudo apt-get install -y ssh

  pre_build:
    commands:
      - echo "Logando no ECR..."
      - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin 572692059120.dkr.ecr.eu-west-3.amazonaws.com

  build:
    commands:
      - echo "Construindo imagem backend..."
      - docker build -t $ECR_REPOSITORY_BACKEND ./backend
      - echo "Construindo imagem frontend..."
      - docker build -t $ECR_REPOSITORY_FRONTEND ./frontend

  post_build:
    commands:
      - echo "Tagging imagens..."
      - docker tag $ECR_REPOSITORY_BACKEND:latest 572692059120.dkr.ecr.eu-west-3.amazonaws.com/$ECR_REPOSITORY_BACKEND:latest
      - docker tag $ECR_REPOSITORY_FRONTEND:latest 572692059120.dkr.ecr.eu-west-3.amazonaws.com/$ECR_REPOSITORY_FRONTEND:latest
      - echo "Push para ECR..."
      - docker push 572692059120.dkr.ecr.eu-west-3.amazonaws.com/$ECR_REPOSITORY_BACKEND:latest
      - docker push 572692059120.dkr.ecr.eu-west-3.amazonaws.com/$ECR_REPOSITORY_FRONTEND:latest
      - echo "Deploy no EC2..."
      - |
        ssh -o StrictHostKeyChecking=no -i $SSH_KEY_PATH $EC2_USER@$EC2_HOST << 'EOF'
          docker pull 572692059120.dkr.ecr.eu-west-3.amazonaws.com/$ECR_REPOSITORY_BACKEND:latest
          docker pull 572692059120.dkr.ecr.eu-west-3.amazonaws.com/$ECR_REPOSITORY_FRONTEND:latest
          docker-compose -f ~/Auto-Generated-Blog/infra/docker-compose.yml down
          docker-compose -f ~/Auto-Generated-Blog/infra/docker-compose.yml up -d
        EOF

artifacts:
  files:
    - "**/*"
